"use strict";

var mongo_connector_1 = require("../../backend/mongo-connector");
var model_1 = require("../../../model/model");
var logger_1 = require("../../logger");
var MindFlowController = {
    findAll: function (req, res) {
        var userId = req.query.userId;
        logger_1.logger.debug("Find All mind flows for user : " + userId);
        mongo_connector_1.MongoMindFlow.find({ userId: userId }, function (err, flows) {
            if (err) return res.json(500, { message: 'ERROR', content: err });
            var response = model_1.Response.aSuccess(flows);
            res.json(response.status, response.body);
            res.end();
        });
    },
    create: function (req, res) {
        var body = req.body;
        logger_1.logger.debug("Create mind flow for user : " + body.userId);
        if (body) {
            var mongoMindFlow = new mongo_connector_1.MongoMindFlow(body);
            mongoMindFlow.save(function (err, flow) {
                var response = err && model_1.Response.aError(err) || model_1.Response.aSuccess(flow);
                res.json(response.status, response.body);
                res.end();
            });
        }
    },
    findFlow: function (req, res) {
        var flowId = req.params.flowId;
        logger_1.logger.debug("mind-flow: " + flowId);
        mongo_connector_1.MongoMindFlow.findOne({ _id: flowId }, function (err, flow) {
            if (err) return res.json(500, { message: 'ERROR', content: err });
            var response = model_1.Response.aSuccess(flow);
            res.json(response.status, response.body);
            res.end();
        });
    },
    deleteFlow: function (req, res) {
        var flowId = req.params.flowId;
        logger_1.logger.debug("Delete mind-flow: " + flowId);
        mongo_connector_1.MongoMindFlow.findByIdAndRemove(flowId, function (err, retVal) {
            if (err) return res.json(500, { message: 'ERROR', content: err });
            var response = retVal == null && model_1.Response.aError({ message: 'mind-flow not found' }) || model_1.Response.aSuccess(retVal);
            res.json(response.status, response.body);
            res.end();
        });
    },
    updateFlow: function (req, res) {
        var flowId = req.params.flowId;
        var body = req.body;
        logger_1.logger.debug("Update mind-flow: " + flowId);
        if (body) {
            mongo_connector_1.MongoMindFlow.findByIdAndUpdate(flowId, { $set: body }, function (err, retVal) {
                if (err) return res.json(500, { message: 'ERROR', content: err });
                var response = retVal == null && model_1.Response.aError({ message: 'mind-flow not found' }) || model_1.Response.aSuccess();
                res.json(response.status, response.body);
                res.end();
            });
        }
    },
    addStep: function (req, res) {
        var body = req.body;
        var id = req.params.flowId;
        logger_1.logger.debug("AddRootStep to mindFlow: " + id);
        console.log(JSON.stringify(body));
        if (body) {
            mongo_connector_1.MongoMindFlow.findOne({ _id: id }, function (err, mindFlow) {
                if (mindFlow) {
                    mindFlow.rootSteps.push(body);
                    mongo_connector_1.MongoMindFlow.findByIdAndUpdate(id, { $set: mindFlow }, function (err, retVal) {
                        if (err) return res.json(500, { message: 'ERROR', content: err });
                        var response = retVal == null && model_1.Response.aError({ message: 'mindFlow not found' }) || model_1.Response.aSuccess();
                        res.json(response.status, response.body);
                        res.end();
                    });
                } else {
                    var response = model_1.Response.aError({ message: 'mindFlow not found' });
                    res.json(response.status, response.body);
                    res.end();
                }
            });
        }
    },
    deleteStep: function (req, res) {
        var body = req.body;
        var id = req.params.flowId;
        logger_1.logger.debug("Remove RootStep from MindFlow: " + id);
        if (body) {
            mongo_connector_1.MongoMindFlow.findOne({ _id: id }, function (err, mindFlow) {
                if (mindFlow) {
                    for (var idx = 0; idx < mindFlow.rootSteps.length; idx++) {
                        if (mindFlow.rootSteps[idx].concern === body.concern) {
                            var step = mindFlow.rootSteps.splice(idx);
                            logger_1.logger.debug("Removing " + step);
                            mongo_connector_1.MongoMindFlow.findByIdAndUpdate(id, { $set: mindFlow }, function (err, retVal) {
                                return defaultUpdate(res, err, retVal);
                            });
                        }
                    }
                }
            });
        } else {
            var response = model_1.Response.aError({ message: 'concept not found' });
            res.json(response.status, response.body);
            res.end();
        }
    }
};
exports.MindFlowController = MindFlowController;
//---------------------privates----------------------------
function defaultUpdate(res, err, retVal) {
    if (err) return res.json(500, { message: 'ERROR', content: err });
    var response = retVal == null && new model_1.Response(500, {
        message: 'item not found',
        content: {}
    }) || new model_1.Response(200, { message: 'updated', content: {} });
    res.json(response.status, response.body);
    res.end();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZlci9hcGkvbWluZC1mbG93L21pbmQtZmxvdy1jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUEsb0JBQUEsUUFBNEIsK0JBQTVCLENBQUE7QUFDQSxJQUFBLFVBQUEsUUFBMkMsc0JBQTNDLENBQUE7QUFDQSxJQUFBLFdBQUEsUUFBcUIsY0FBckIsQ0FBQTtBQUVBLElBQUkscUJBQXFCO0FBQ3ZCLGFBQVMsVUFBVSxHQUFWLEVBQW9CLEdBQXBCLEVBQTRCO0FBQ25DLFlBQUksU0FBUyxJQUFJLEtBQUosQ0FBVSxNQUF2QjtBQUNBLGlCQUFBLE1BQUEsQ0FBTyxLQUFQLENBQWEsb0NBQW9DLE1BQWpEO0FBQ0EsMEJBQUEsYUFBQSxDQUFjLElBQWQsQ0FBbUIsRUFBQyxRQUFRLE1BQVQsRUFBbkIsRUFBcUMsVUFBVSxHQUFWLEVBQW9CLEtBQXBCLEVBQTBDO0FBQzdFLGdCQUFJLEdBQUosRUFBUyxPQUFPLElBQUksSUFBSixDQUFTLEdBQVQsRUFBYyxFQUFDLFNBQVMsT0FBVixFQUFtQixTQUFTLEdBQTVCLEVBQWQsQ0FBUDtBQUNULGdCQUFJLFdBQXFCLFFBQUEsUUFBQSxDQUFTLFFBQVQsQ0FBa0IsS0FBbEIsQ0FBekI7QUFDQSxnQkFBSSxJQUFKLENBQVMsU0FBUyxNQUFsQixFQUEwQixTQUFTLElBQW5DO0FBQ0EsZ0JBQUksR0FBSjtBQUNELFNBTEQ7QUFNRCxLQVZzQjtBQVd2QixZQUFRLFVBQVUsR0FBVixFQUFvQixHQUFwQixFQUE0QjtBQUNsQyxZQUFJLE9BQWlCLElBQUksSUFBekI7QUFDQSxpQkFBQSxNQUFBLENBQU8sS0FBUCxDQUFhLGlDQUFpQyxLQUFLLE1BQW5EO0FBQ0EsWUFBSSxJQUFKLEVBQVU7QUFDUixnQkFBSSxnQkFBZ0IsSUFBSSxrQkFBQSxhQUFKLENBQWtCLElBQWxCLENBQXBCO0FBQ0EsMEJBQWMsSUFBZCxDQUFtQixVQUFVLEdBQVYsRUFBb0IsSUFBcEIsRUFBa0M7QUFD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LEdBQWpDLEVBQTJDLE1BQTNDLEVBQXNEO0FBQ3BELFFBQUksR0FBSixFQUFTLE9BQU8sSUFBSSxJQUFKLENBQVMsR0FBVCxFQUFjLEVBQUMsU0FBUyxPQUFWLEVBQW1CLFNBQVMsR0FBNUIsRUFBZCxDQUFQO0FBQ1QsUUFBSSxXQUFzQixVQUFVLElBQVYsSUFBa0IsSUFBSSxRQUFBLFFBQUosQ0FBYSxHQUFiLEVBQWtCO0FBQzFELGlCQUFTLGdCQURpRDtBQUUxRCxpQkFBUztBQUZpRCxLQUFsQixDQUFuQixJQUdoQixJQUFJLFFBQUEsUUFBSixDQUFhLEdBQWIsRUFBa0IsRUFBQyxTQUFTLFNBQVYsRUFBcUIsU0FBUyxFQUE5QixFQUFsQixDQUhUO0FBSUEsUUFBSSxJQUFKLENBQVMsU0FBUyxNQUFsQixFQUEwQixTQUFTLElBQW5DO0FBQ0EsUUFBSSxHQUFKO0FBQ0QiLCJmaWxlIjoic2VydmVyL2FwaS9taW5kLWZsb3cvbWluZC1mbG93LWNvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbmltcG9ydCB7TW9uZ29NaW5kRmxvd30gZnJvbSBcIi4uLy4uL2JhY2tlbmQvbW9uZ28tY29ubmVjdG9yXCI7XG5pbXBvcnQge1Jlc3BvbnNlLCBGbG93U3RlcCwgTWluZEZsb3d9IGZyb20gXCIuLi8uLi8uLi9tb2RlbC9tb2RlbFwiO1xuaW1wb3J0IHtsb2dnZXJ9IGZyb20gXCIuLi8uLi9sb2dnZXJcIjtcblxudmFyIE1pbmRGbG93Q29udHJvbGxlciA9IHtcbiAgZmluZEFsbDogZnVuY3Rpb24gKHJlcTogYW55LCByZXM6IGFueSkge1xuICAgIHZhciB1c2VySWQgPSByZXEucXVlcnkudXNlcklkO1xuICAgIGxvZ2dlci5kZWJ1ZyhcIkZpbmQgQWxsIG1pbmQgZmxvd3MgZm9yIHVzZXIgOiBcIiArIHVzZXJJZCk7XG4gICAgTW9uZ29NaW5kRmxvdy5maW5kKHt1c2VySWQ6IHVzZXJJZH0sIGZ1bmN0aW9uIChlcnI6IGFueSwgZmxvd3M6IEFycmF5PE1pbmRGbG93Pikge1xuICAgICAgaWYgKGVycikgcmV0dXJuIHJlcy5qc29uKDUwMCwge21lc3NhZ2U6ICdFUlJPUicsIGNvbnRlbnQ6IGVycn0pO1xuICAgICAgbGV0IHJlc3BvbnNlOiBSZXNwb25zZSA9IFJlc3BvbnNlLmFTdWNjZXNzKGZsb3dzKTtcbiAgICAgIHJlcy5qc29uKHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuYm9keSk7XG4gICAgICByZXMuZW5kKCk7XG4gICAgfSk7XG4gIH0sXG4gIGNyZWF0ZTogZnVuY3Rpb24gKHJlcTogYW55LCByZXM6IGFueSkge1xuICAgIHZhciBib2R5OiBNaW5kRmxvdyA9IHJlcS5ib2R5O1xuICAgIGxvZ2dlci5kZWJ1ZyhcIkNyZWF0ZSBtaW5kIGZsb3cgZm9yIHVzZXIgOiBcIiArIGJvZHkudXNlcklkKTtcbiAgICBpZiAoYm9keSkge1xuICAgICAgbGV0IG1vbmdvTWluZEZsb3cgPSBuZXcgTW9uZ29NaW5kRmxvdyhib2R5KTtcbiAgICAgIG1vbmdvTWluZEZsb3cuc2F2ZShmdW5jdGlvbiAoZXJyOiBhbnksIGZsb3c6IE1pbmRGbG93KSB7XG4gICAgICAgIGxldCByZXNwb25zZTogUmVzcG9uc2UgPSAoZXJyICYmIFJlc3BvbnNlLmFFcnJvcihlcnIpKSB8fCBSZXNwb25zZS5hU3VjY2VzcyhmbG93KTtcbiAgICAgICAgcmVzLmpzb24ocmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5ib2R5KTtcbiAgICAgICAgcmVzLmVuZCgpO1xuICAgICAgfSk7XG4gICAgfVxuICB9LFxuICBmaW5kRmxvdzogZnVuY3Rpb24gKHJlcTogYW55LCByZXM6IGFueSkge1xuICAgIGxldCBmbG93SWQgPSByZXEucGFyYW1zLmZsb3dJZDtcbiAgICBsb2dnZXIuZGVidWcoXCJtaW5kLWZsb3c6IFwiICsgZmxvd0lkKTtcbiAgICBNb25nb01pbmRGbG93LmZpbmRPbmUoe19pZDogZmxvd0lkfSwgZnVuY3Rpb24gKGVycjogYW55LCBmbG93OiBNaW5kRmxvdykge1xuICAgICAgaWYgKGVycikgcmV0dXJuIHJlcy5qc29uKDUwMCwge21lc3NhZ2U6ICdFUlJPUicsIGNvbnRlbnQ6IGVycn0pO1xuICAgICAgbGV0IHJlc3BvbnNlOiBSZXNwb25zZSA9IFJlc3BvbnNlLmFTdWNjZXNzKGZsb3cpO1xuICAgICAgcmVzLmpzb24ocmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5ib2R5KTtcbiAgICAgIHJlcy5lbmQoKTtcbiAgICB9KTtcbiAgfSxcbiAgZGVsZXRlRmxvdzogZnVuY3Rpb24gKHJlcTogYW55LCByZXM6IGFueSkge1xuICAgIGxldCBmbG93SWQgPSByZXEucGFyYW1zLmZsb3dJZDtcbiAgICBsb2dnZXIuZGVidWcoXCJEZWxldGUgbWluZC1mbG93OiBcIiArIGZsb3dJZCk7XG4gICAgTW9uZ29NaW5kRmxvdy5maW5kQnlJZEFuZFJlbW92ZShmbG93SWQsIGZ1bmN0aW9uIChlcnI6IGFueSwgcmV0VmFsOiBNaW5kRmxvdykge1xuICAgICAgaWYgKGVycikgcmV0dXJuIHJlcy5qc29uKDUwMCwge21lc3NhZ2U6ICdFUlJPUicsIGNvbnRlbnQ6IGVycn0pO1xuICAgICAgbGV0IHJlc3BvbnNlOiBSZXNwb25zZSA9IChyZXRWYWwgPT0gbnVsbCAmJiBSZXNwb25zZS5hRXJyb3Ioe21lc3NhZ2U6ICdtaW5kLWZsb3cgbm90IGZvdW5kJ30pKSB8fCBSZXNwb25zZS5hU3VjY2VzcyhyZXRWYWwpO1xuICAgICAgcmVzLmpzb24ocmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5ib2R5KTtcbiAgICAgIHJlcy5lbmQoKTtcbiAgICB9KTtcbiAgfSxcbiAgdXBkYXRlRmxvdzogZnVuY3Rpb24gKHJlcTogYW55LCByZXM6IGFueSkge1xuICAgIGxldCBmbG93SWQgPSByZXEucGFyYW1zLmZsb3dJZDtcbiAgICBsZXQgYm9keSA9IHJlcS5ib2R5O1xuICAgIGxvZ2dlci5kZWJ1ZyhcIlVwZGF0ZSBtaW5kLWZsb3c6IFwiICsgZmxvd0lkKTtcbiAgICBpZiAoYm9keSkge1xuICAgICAgTW9uZ29NaW5kRmxvdy5maW5kQnlJZEFuZFVwZGF0ZShmbG93SWQsIHskc2V0OiBib2R5fSwgZnVuY3Rpb24gKGVycjogYW55LCByZXRWYWw6IE1pbmRGbG93KSB7XG4gICAgICAgIGlmIChlcnIpIHJldHVybiByZXMuanNvbig1MDAsIHttZXNzYWdlOiAnRVJST1InLCBjb250ZW50OiBlcnJ9KTtcbiAgICAgICAgbGV0IHJlc3BvbnNlOiBSZXNwb25zZSA9IChyZXRWYWwgPT0gbnVsbCAmJiBSZXNwb25zZS5hRXJyb3Ioe21lc3NhZ2U6ICdtaW5kLWZsb3cgbm90IGZvdW5kJ30pKSB8fCBSZXNwb25zZS5hU3VjY2VzcygpO1xuICAgICAgICByZXMuanNvbihyZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLmJvZHkpO1xuICAgICAgICByZXMuZW5kKCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG4gIGFkZFN0ZXA6IGZ1bmN0aW9uIChyZXE6IGFueSwgcmVzOiBhbnkpIHtcbiAgICB2YXIgYm9keTogRmxvd1N0ZXAgPSByZXEuYm9keTtcbiAgICB2YXIgaWQgPSByZXEucGFyYW1zLmZsb3dJZDtcbiAgICBsb2dnZXIuZGVidWcoYEFkZFJvb3RTdGVwIHRvIG1pbmRGbG93OiAke2lkfWApO1xuICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGJvZHkpKTtcbiAgICBpZiAoYm9keSkge1xuICAgICAgTW9uZ29NaW5kRmxvdy5maW5kT25lKHtfaWQ6IGlkfSwgZnVuY3Rpb24gKGVycjogYW55LCBtaW5kRmxvdzogTWluZEZsb3cpIHtcbiAgICAgICAgaWYgKG1pbmRGbG93KSB7XG4gICAgICAgICAgbWluZEZsb3cucm9vdFN0ZXBzLnB1c2goYm9keSk7XG4gICAgICAgICAgTW9uZ29NaW5kRmxvdy5maW5kQnlJZEFuZFVwZGF0ZShpZCwgeyRzZXQ6IG1pbmRGbG93fSwgZnVuY3Rpb24gKGVycjogYW55LCByZXRWYWw6IE1pbmRGbG93KSB7XG4gICAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVzLmpzb24oNTAwLCB7bWVzc2FnZTogJ0VSUk9SJywgY29udGVudDogZXJyfSk7XG4gICAgICAgICAgICBsZXQgcmVzcG9uc2U6IFJlc3BvbnNlID0gKHJldFZhbCA9PSBudWxsICYmIFJlc3BvbnNlLmFFcnJvcih7bWVzc2FnZTogJ21pbmRGbG93IG5vdCBmb3VuZCd9KSlcbiAgICAgICAgICAgICAgfHwgUmVzcG9uc2UuYVN1Y2Nlc3MoKTtcbiAgICAgICAgICAgIHJlcy5qc29uKHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuYm9keSk7XG4gICAgICAgICAgICByZXMuZW5kKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbGV0IHJlc3BvbnNlOiBSZXNwb25zZSA9IFJlc3BvbnNlLmFFcnJvcih7bWVzc2FnZTogJ21pbmRGbG93IG5vdCBmb3VuZCd9KTtcbiAgICAgICAgICByZXMuanNvbihyZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLmJvZHkpO1xuICAgICAgICAgIHJlcy5lbmQoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9LFxuICBkZWxldGVTdGVwOiBmdW5jdGlvbiAocmVxOiBhbnksIHJlczogYW55KSB7XG4gICAgdmFyIGJvZHk6IEZsb3dTdGVwID0gcmVxLmJvZHk7XG4gICAgdmFyIGlkID0gcmVxLnBhcmFtcy5mbG93SWQ7XG4gICAgbG9nZ2VyLmRlYnVnKGBSZW1vdmUgUm9vdFN0ZXAgZnJvbSBNaW5kRmxvdzogJHtpZH1gKTtcbiAgICBpZiAoYm9keSkge1xuICAgICAgTW9uZ29NaW5kRmxvdy5maW5kT25lKHtfaWQ6IGlkfSwgZnVuY3Rpb24gKGVycjogYW55LCBtaW5kRmxvdzogTWluZEZsb3cpIHtcbiAgICAgICAgaWYgKG1pbmRGbG93KSB7XG4gICAgICAgICAgZm9yIChsZXQgaWR4ID0gMDsgaWR4IDwgbWluZEZsb3cucm9vdFN0ZXBzLmxlbmd0aDsgaWR4KyspIHtcbiAgICAgICAgICAgIGlmIChtaW5kRmxvdy5yb290U3RlcHNbaWR4XS5jb25jZXJuID09PSBib2R5LmNvbmNlcm4pIHtcbiAgICAgICAgICAgICAgdmFyIHN0ZXAgPSBtaW5kRmxvdy5yb290U3RlcHMuc3BsaWNlKGlkeCk7XG4gICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhgUmVtb3ZpbmcgJHtzdGVwfWApO1xuICAgICAgICAgICAgICBNb25nb01pbmRGbG93LmZpbmRCeUlkQW5kVXBkYXRlKGlkLCB7JHNldDogbWluZEZsb3d9LFxuICAgICAgICAgICAgICAgIChlcnI6IGFueSwgcmV0VmFsOiBNaW5kRmxvdykgPT4gZGVmYXVsdFVwZGF0ZShyZXMsIGVyciwgcmV0VmFsKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgcmVzcG9uc2U6IFJlc3BvbnNlID0gUmVzcG9uc2UuYUVycm9yKHttZXNzYWdlOiAnY29uY2VwdCBub3QgZm91bmQnfSk7XG4gICAgICByZXMuanNvbihyZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLmJvZHkpO1xuICAgICAgcmVzLmVuZCgpO1xuICAgIH0gIH1cblxufTtcblxuZXhwb3J0IHtNaW5kRmxvd0NvbnRyb2xsZXJ9O1xuXG4vLy0tLS0tLS0tLS0tLS0tLS0tLS0tLXByaXZhdGVzLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5mdW5jdGlvbiBkZWZhdWx0VXBkYXRlKHJlczogYW55LCBlcnI6IGFueSwgcmV0VmFsOiBhbnkpe1xuICBpZiAoZXJyKSByZXR1cm4gcmVzLmpzb24oNTAwLCB7bWVzc2FnZTogJ0VSUk9SJywgY29udGVudDogZXJyfSk7XG4gIGxldCByZXNwb25zZTogUmVzcG9uc2UgPSAocmV0VmFsID09IG51bGwgJiYgbmV3IFJlc3BvbnNlKDUwMCwge1xuICAgICAgbWVzc2FnZTogJ2l0ZW0gbm90IGZvdW5kJyxcbiAgICAgIGNvbnRlbnQ6IHt9XG4gICAgfSkpIHx8IG5ldyBSZXNwb25zZSgyMDAsIHttZXNzYWdlOiAndXBkYXRlZCcsIGNvbnRlbnQ6IHt9fSk7XG4gIHJlcy5qc29uKHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuYm9keSk7XG4gIHJlcy5lbmQoKTtcbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
